/**
 * Midea AC Smart Temperature (Hubitat Elevation)
 * Midea AC via hubitat_midea driver + temperature sensor.
 *
 * After 9 pm:
 * - fan → silent (if supported)
 * - gradually lower AC heating setpoint by 1°C at a time
 *   such that:
 *   - room temp never drops >1°C below current setpoint
 *   - setpoint changes ~1–2°C per hour (via 30‑minute tick)
 */
definition(
    name: "Midea Smart Night Heating",
    namespace: "perplexity",
    author: "Perplexity",
    description: "Gradual night heating for Midea AC; 1°C steps, 1–2°C/hour.",
    category: "Convenience",
    iconUrl: "",
    iconX2Url: "",
    singleInstance: true
)

preferences {
    page(name: "mainPage")
}

def mainPage() {
    dynamicPage(name: "mainPage", title: "Midea Smart Night Heating", install: true, uninstall: true) {
        section("Devices") {
            input "tempSensor", "capability.temperatureMeasurement", title: "Temperature Sensor", required: true
            input "mideaThermostat", "capability.thermostat", title: "Midea AC (hubitat_midea driver)", required: true
        }
        section("Day Cooling Settings") {
            input "coolThreshold", "decimal", title: "Cooling ON when room temp > (°C)", defaultValue: 28.0
            input "coolSetpoint", "decimal", title: "Cooling setpoint (°C)", defaultValue: 26.0
        }
        section("Night Heating Settings") {
            input "heatMaxDayTemp", "decimal", title: "Max day temp threshold (°C) to enable night heating", defaultValue: 22.0
            input "nightStartHour", "number", title: "Evening heating start hour (24h)", defaultValue: 18)
            input "silentFanHour", "number", title: "Switch fan to silent after (hour)", defaultValue: 21)
            input "minHeatingSetpoint", "decimal", title: "Minimum AC heating setpoint (°C)", defaultValue: 16.0
            input "maxHeatingSetpoint", "decimal", title: "Maximum AC heating setpoint (°C)", defaultValue: 22.0
        }
    }
}

def installed() { log.debug "Installed: ${settings}"; initialize() }

def updated() {
    log.debug "Updated: ${settings}"
    unsubscribe()
    unschedule()
    initialize()
}

def initialize() {
    subscribe(tempSensor, "temperature", handleTemp)
    runEvery15Minutes(updateDayMaxTemp)
    schedule("${nightStartHour} 0 0 * * ?", startNightHeating)
    schedule("${silentFanHour} 0 0 * * ?", setFanSilent)
    // Run the gradual‑heating tick every 30 minutes from 9 pm to 7 am
    schedule("0 21-7/0.5 * * * ?", tickGradualHeating)
}

// --------- Day Cooling Logic --------- //
def handleTemp(evt) {
    BigDecimal currentTemp = evt.value as BigDecimal
    String currentMode = mideaThermostat.currentValue("thermostatMode")
    BigDecimal currentCoolSp = mideaThermostat.currentValue("coolingSetpoint") as BigDecimal

    if (currentTemp > coolThreshold) {
        if (currentMode != "auto") {
            mideaThermostat.setThermostatMode("auto")
            mideaThermostat.setCoolingSetpoint(coolSetpoint)
            log.debug "Day Cooling: ${currentTemp}°C > ${coolThreshold}°C → Auto, coolSp=${coolSetpoint}"
        } else if (currentCoolSp != coolSetpoint) {
            mideaThermostat.setCoolingSetpoint(coolSetpoint)
        }
    }
}

// Track today’s max temp (simple rolling max)
def updateDayMaxTemp() {
    BigDecimal current = tempSensor.currentValue("temperature") as BigDecimal
    state.maxTempToday = state.maxTempToday
        ? Math.max(state.maxTempToday, current)
        : current
}

def wouldDoNightHeating() {
    BigDecimal max = state.maxTempToday ?: 0.0
    return max < heatMaxDayTemp
}

// --------- Night Heating: initialization at nightStartHour --------- //
def startNightHeating() {
    if (!wouldDoNightHeating()) {
        log.debug "Max temp today (${state.maxTempToday}) ≥ ${heatMaxDayTemp}; skipping night heating"
        return
    }

    BigDecimal currentTemp = tempSensor.currentValue("temperature") as BigDecimal
    String currentMode = mideaThermostat.currentValue("thermostatMode")
    String currentFan = mideaThermostat.currentValue("thermostatFanMode")

    if (currentMode != "heat") {
        mideaThermostat.setThermostatMode("heat")
        mideaThermostat.setHeatingSetpoint(maxHeatingSetpoint)
        if (currentFan != "auto") {
            mideaThermostat.setThermostatFanMode("auto")
        }
        log.debug "Night Heating: starting at ${maxHeatingSetpoint}°C, fan auto (room=${currentTemp}°C)"
    }
}

// After 21:00 → set fan to silent if supported
def setFanSilent() {
    if (!wouldDoNightHeating()) { return }
    if (!mideaThermostat.hasCommand("setThermostatFanMode")) { return }

    String currentMode = mideaThermostat.currentValue("thermostatMode")
    if (currentMode != "heat") { return }

    def supportedFans = mideaThermostat.currentValue("supportedThermostatFanModes")
    if (supportedFans?.toString().contains("silent")) {
        try {
            mideaThermostat.setThermostatFanMode("silent")
            log.debug "Night Heating: fan → silent"
        } catch (ignored) {
            log.debug "Failed to set fan to silent; device may not support it."
        }
    } else {
        log.debug "Night Heating: silent fan mode not supported; keeping current fan"
    }
}

// --------- Gradual heating setpoint drop (every 30 minutes) --------- //
def tickGradualHeating() {
    if (!wouldDoNightHeating()) { return }

    String currentMode = mideaThermostat.currentValue("thermostatMode")
    if (currentMode != "heat") { return }

    BigDecimal currentTemp = tempSensor.currentValue("temperature") as BigDecimal
    BigDecimal currentSp = mideaThermostat.currentValue("heatingSetpoint") as BigDecimal

    // Clamp setpoint to operational range
    if (currentSp < minHeatingSetpoint) {
        mideaThermostat.setHeatingSetpoint(minHeatingSetpoint)
        log.debug "Night Heating: clamped setpoint to minimum ${minHeatingSetpoint}°C"
        return
    }

    // 1. Never drop setpoint if room is more than 1°C below it
    if (currentTemp < currentSp - 1.0) {
        log.debug "Night Heating: room=${currentTemp}°C, setpoint=${currentSp}°C → room >1°C below; NOT lowering setpoint"
        return
    }

    // 2. Only allow lowering if above minimum
    if (currentSp <= minHeatingSetpoint) {
        log.debug "Night Heating: already at minimum ${minHeatingSetpoint}°C"
        return
    }

    // 3. Drop by 1°C, but no lower than 16°C
    BigDecimal newSp = Math.max(currentSp - 1.0, minHeatingSetpoint) as BigDecimal
    if (newSp != currentSp) {
        mideaThermostat.setHeatingSetpoint(newSp)
        log.debug "Night Heating: dropping setpoint from ${currentSp}°C → ${newSp}°C (room=${currentTemp}°C)"
    }
}
