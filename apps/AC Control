definition(
    name: "Automated AC Control",
    namespace: "custom",
    author: "Perplexity",
    description: "One room: Outdoor > indoor → AC auto + outdoor setpoint (30min checks). Clone for more rooms.",
    category: "Green Living",
    iconUrl: "",
    iconX2Url: "",
    singleInstance: false
)

preferences {
    page name: "mainPage"
}

def mainPage() {
    dynamicPage(name: "mainPage", title: "AC Control (One Room Pair)", install: true, uninstall: true) {
        section("This Room's Devices") {
            input "outdoorWeather", "device.OpenWeatherMap", title: "OpenWeatherMap Device", required: true
            input "indoorSensor", "capability.temperatureMeasurement", title: "Indoor Temp Sensor", required: true
            input "acThermostat", "capability.thermostat", title: "Thermostat/AC Unit", required: true
        }
        section("Preview") {
            paragraph "<b>${indoorSensor?.displayName ?: 'Select'} → ${acThermostat?.displayName ?: 'Select'}</b>"
            paragraph "<small>Clone app (Add User App) for additional rooms.</small>"
        }
    }
}

def installed() {
    initialize()
}

def updated() {
    unschedule()
    initialize()
}

def initialize() {
    subscribe(indoorSensor, "temperature", tempHandler)
    subscribe(outdoorWeather, "temperature", tempHandler)
    runEvery30Minutes("tempHandler")
    runIn(30, tempHandler)
    log.info "${indoorSensor.displayName} → ${acThermostat.displayName} initialized"
}

def tempHandler(evt = null) {
    def outdoorTemp = outdoorWeather.currentValue("temperature")?.toBigDecimal()
    def indoorTemp = indoorSensor.currentValue("temperature")?.toBigDecimal()
    
    if (!outdoorTemp || !indoorTemp) {
        log.warn "Missing temps: outdoor=${outdoorTemp}, indoor=${indoorTemp}"
        return
    }
    
    log.info "${indoorSensor.displayName}: indoor ${indoorTemp}° vs outdoor ${outdoorTemp}°"
    
    if (outdoorTemp > indoorTemp) {
        log.info "❄️ ${acThermostat.displayName}: AUTO + ${outdoorTemp}°"
        acThermostat.setThermostatMode("auto")
        acThermostat.setCoolingSetpoint(outdoorTemp)
    } else {
        log.info "No action needed"
    }
}
