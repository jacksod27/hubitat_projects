definition(
    name: "Automated AC Control",
    namespace: "custom",
    author: "Perplexity",
    description: "One room: Outdoor > indoor → AC auto + outdoor setpoint (30min checks). Clone & rename for rooms.",
    category: "Green Living",
    iconUrl: "",
    iconX2Url: "",
    singleInstance: false
)

preferences {
    page name: "mainPage"
}

def mainPage() {
    dynamicPage(name: "mainPage", title: "AC Control (One Room Pair)", install: true, uninstall: true) {
        section("Instance Name") {
            label title: "App Name (e.g., 'Front Room AC')", required: true
        }
        section("Devices") {
            input "outdoorWeather", "device.OpenWeatherMap", title: "OpenWeatherMap Device", required: true
            input "indoorSensor", "capability.temperatureMeasurement", title: "Indoor Temp Sensor", required: true
            input "acThermostat", "capability.thermostat", title: "Thermostat/AC Unit", required: true
        }
        section("Preview") {
            paragraph "<b>[${label ?: 'Unnamed'}] ${indoorSensor?.displayName ?: '?'} → ${acThermostat?.displayName ?: '?'}</b>"
        }
        section("Schedule (Optional)") {
    		input "days", "enum", title: "Days Only", multiple: true, required: false,
        		options: ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"]
    		input "modes", "mode", title: "Modes Only", multiple: true, required: false
    		input "startTime", "time", title: "From Time", required: false
    		input "endTime", "time", title: "Until Time", required
        }
    }
}



def installed() {
    log.info "Installed: ${app.label}"
    initialize()
}

def updated() {
    unschedule()
    log.info "Updated: ${app.label} (${indoorSensor.displayName} → ${acThermostat.displayName})"
    initialize()
}

def initialize() {
    subscribe(indoorSensor, "temperature", tempHandler)
    subscribe(outdoorWeather, "temperature", tempHandler)
    runEvery30Minutes("tempHandler")
    runIn(30, tempHandler)
}

def tempHandler(evt = null) {
    def instance = app.label ?: "Unnamed"
    def outdoorTemp = outdoorWeather.currentValue("temperature")?.toBigDecimal()
    def indoorTemp = indoorSensor.currentValue("temperature")?.toBigDecimal()
    
    if (!outdoorTemp || !indoorTemp) {
        log.warn "${instance}: Missing temps (out:${outdoorTemp}, in:${indoorTemp})"
        return
    }
    
    log.info "${instance}: ${indoorSensor.displayName} ${indoorTemp}° vs outdoor ${outdoorTemp}°"
    
    if (outdoorTemp > indoorTemp) {
        log.info "${instance}: ❄️ ${acThermostat.displayName} → AUTO + ${outdoorTemp}°"
        acThermostat.setThermostatMode("auto")
        acThermostat.setCoolingSetpoint(outdoorTemp)
    } else {
        log.info "${instance}: No action"
    }
}
