definition(
    name: "AC Control",
    namespace: "custom",
    author: "Perplexity",
    description: "Controls AC when outdoor > indoor temp, checks every 30 min",
    category: "Green Living",
    iconUrl: "",
    iconX2Url: "",
    singleInstance: false
)

preferences {
    page name: "mainPage"
}

def mainPage() {
    dynamicPage(name: "mainPage", title: "Automated AC Control", install: true, uninstall: true) {
        section("Shared Devices") {
            input "outdoorWeather", "device.OpenWeatherMap", title: "OpenWeatherMap Outdoor Temp Device", required: true, multiple: false
        }
        section("Room Pairs (Multi-Select for Multiple Rooms)") {
            input "indoorSensors", "capability.temperatureMeasurement", title: "Indoor Temp Sensors (one per room)", required: true, multiple: true
            input "acThermostats", "device.ThermostatController", title: "Thermostat Controller ACs (match to sensors)", required: true, multiple: true
        }
        section("Notes") {
            paragraph "Select same number of sensors and thermostats. App applies logic to each pair (sensor[i] -> thermostat[i])."
        }
    }
}

def installed() {
    initialize()
}

def updated() {
    unschedule()
    initialize()
}

def initialize() {
    runEvery30Minutes("tempHandler")
    runIn(30, tempHandler)
}

def tempHandler() {
    def outdoorTemp = outdoorWeather.currentValue("temperature")?.toBigDecimal()
    if (!outdoorTemp) {
        log.warn "Missing outdoor temperature data"
        return
    }
    
    def numPairs = indoorSensors?.size() ?: 0
    if (numPairs != acThermostats?.size()) {
        log.warn "Mismatch in sensor/thermostat count: ${numPairs} vs ${acThermostats?.size()}"
        return
    }
    
    log.info "30min check - Outdoor: ${outdoorTemp}°"
    
    indoorSensors.eachWithIndex { sensor, index ->
        def indoorTemp = sensor.currentValue("temperature")?.toBigDecimal()
        def thermostat = acThermostats[index]
        
        if (!indoorTemp) {
            log.warn "Missing indoor temp for ${sensor.displayName}"
            return
        }
        
        log.info "${sensor.displayName}: Indoor ${indoorTemp}°"
        
        if (outdoorTemp > indoorTemp) {
            log.info "${sensor.displayName}: Outdoor > Indoor - Set ${thermostat.displayName} to auto, setpoint ${outdoorTemp}"
            thermostat.setThermostatMode("auto")
            thermostat.setCoolingSetpoint(outdoorTemp)
        } else {
            log.info "${sensor.displayName}: No action"
        }
    }
}
